name: ðŸš€ Deploy SmartLead to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes'
        required: false
        default: 'false'

jobs:
  deploy:
    name: ðŸŒ Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ï¿½ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Cores para output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'
          
          echo -e "${GREEN}ðŸš€ Iniciando deploy automÃ¡tico do SmartLead...${NC}"
          
          # Instalar dependÃªncias se necessÃ¡rio
          if ! command -v make &> /dev/null; then
            echo -e "${YELLOW}ðŸ“¦ Instalando Make...${NC}"
            apt update && apt install -y make
          fi
          
          if ! command -v docker-compose &> /dev/null; then
            echo -e "${YELLOW}ðŸ“¦ Instalando Docker Compose...${NC}"
            curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          fi
          
          if ! command -v docker &> /dev/null; then
            echo -e "${YELLOW}ðŸ“¦ Instalando Docker...${NC}"
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
          fi
          
          # Navegar para diretÃ³rio ou criar
          cd /opt || mkdir -p /opt && cd /opt
          
          # Se nÃ£o existe o diretÃ³rio, fazer clone
          if [ ! -d "smartlead" ]; then
            echo -e "${YELLOW}ðŸ“¥ Clonando repositÃ³rio...${NC}"
            git clone https://github.com/jeanasilva/test_smartlead.git smartlead
          fi
          
          cd smartlead
          
          # Atualizar cÃ³digo
          echo -e "${YELLOW}ðŸ”„ Atualizando cÃ³digo...${NC}"
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          # Criar arquivo .env.prod automaticamente
          echo -e "${YELLOW}ðŸ“ Criando .env.prod...${NC}"
          cat > .env.prod << 'ENV_EOF'
          # Environment de ProduÃ§Ã£o - SmartLead
          # Gerado automaticamente pelo GitHub Actions
          
          APP_NAME="SmartLead API"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=https://smartlead.jeansilva.dev.br
          
          LOG_CHANNEL=stack
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=error
          
          # Database - ProduÃ§Ã£o
          DB_CONNECTION=mysql
          DB_HOST=db
          DB_PORT=3306
          DB_DATABASE=smartlead_db
          DB_USERNAME=smartlead
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          
          # Redis
          REDIS_HOST=redis
          REDIS_PASSWORD=null
          REDIS_PORT=6379
          
          # Email
          MAIL_MAILER=smtp
          MAIL_HOST=smtp.zoho.com
          MAIL_PORT=587
          MAIL_USERNAME=offboard@offboard.com.br
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=tls
          MAIL_FROM_ADDRESS=offboard@offboard.com.br
          MAIL_FROM_NAME="SmartLead"
          
          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # Frontend URL
          VUE_APP_API_BASE_URL=https://smartlead.jeansilva.dev.br/api
          
          # AWS (opcional)
          AWS_ACCESS_KEY_ID=
          AWS_SECRET_ACCESS_KEY=
          AWS_DEFAULT_REGION=us-east-1
          AWS_BUCKET=
          AWS_USE_PATH_STYLE_ENDPOINT=false
          
          # Pusher (opcional)
          PUSHER_APP_ID=
          PUSHER_APP_KEY=
          PUSHER_APP_SECRET=
          PUSHER_APP_CLUSTER=mt1
          
          MIX_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
          MIX_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
          ENV_EOF
          
          # Executar deploy
          echo -e "${GREEN}ðŸš€ Executando deploy...${NC}"
          chmod +x deploy.sh
          
          # Executar comandos do deploy diretamente (sem make)
          echo -e "${YELLOW}ðŸ“¦ Fazendo backup...${NC}"
          if [ -d "backup" ]; then rm -rf backup; fi
          mkdir -p backup
          
          echo -e "${YELLOW}ðŸ³ Iniciando containers de produÃ§Ã£o...${NC}"
          docker-compose -f docker-compose.prod.yml down || true
          docker-compose -f docker-compose.prod.yml up -d --build
          
          echo -e "${YELLOW}â³ Aguardando containers ficarem prontos...${NC}"
          sleep 30
          
          echo -e "${YELLOW}ðŸ“¦ Instalando dependÃªncias...${NC}"
          docker-compose -f docker-compose.prod.yml exec -T app composer install --no-dev --optimize-autoloader
          
          echo -e "${YELLOW}ðŸ”‘ Gerando chaves...${NC}"
          docker-compose -f docker-compose.prod.yml exec -T app php artisan key:generate --force || true
          docker-compose -f docker-compose.prod.yml exec -T app php artisan jwt:secret --force || true
          
          echo -e "${YELLOW}ðŸ—„ï¸ Configurando banco...${NC}"
          docker-compose -f docker-compose.prod.yml exec -T app php artisan migrate --force
          docker-compose -f docker-compose.prod.yml exec -T app php artisan db:seed --force || true
          
          echo -e "${YELLOW}ðŸ“š Gerando documentaÃ§Ã£o...${NC}"
          docker-compose -f docker-compose.prod.yml exec -T app php artisan l5-swagger:generate || true
          
          # Configurar nginx se necessÃ¡rio
          if [ ! -f /etc/nginx/sites-available/smartlead ]; then
            echo -e "${YELLOW}ðŸŒ Configurando Nginx...${NC}"
            
            # Usar configuraÃ§Ã£o simples primeiro
            cp nginx-config-simple.conf /etc/nginx/sites-available/smartlead
            ln -sf /etc/nginx/sites-available/smartlead /etc/nginx/sites-enabled/
            
            # Adicionar rate limiting ao nginx.conf se nÃ£o existir
            if ! grep -q "limit_req_zone" /etc/nginx/nginx.conf; then
              echo -e "${YELLOW}ðŸ“ Adicionando rate limiting ao nginx.conf...${NC}"
              sed -i '/http {/a\\tlimit_req_zone $binary_remote_addr zone=login:10m rate=3r/m;\n\tlimit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;' /etc/nginx/nginx.conf
            fi
            
            # Testar configuraÃ§Ã£o nginx
            if nginx -t; then
              systemctl reload nginx
              echo -e "${GREEN}âœ… Nginx configurado com sucesso!${NC}"
            else
              echo -e "${RED}âŒ Erro na configuraÃ§Ã£o do Nginx, usando configuraÃ§Ã£o bÃ¡sica...${NC}"
              # Fallback para configuraÃ§Ã£o mÃ­nima
              cat > /etc/nginx/sites-available/smartlead << 'EOF'
          server {
              listen 80;
              server_name smartlead.jeansilva.dev.br;
              
              location / {
                  proxy_pass http://127.0.0.1:8080;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          EOF
              nginx -t && systemctl reload nginx
            fi
            
            # Configurar SSL se certbot estiver instalado
            if command -v certbot &> /dev/null; then
              certbot --nginx -d smartlead.jeansilva.dev.br --non-interactive --agree-tos --email admin@jeansilva.dev.br || true
            fi
          else
            echo -e "${BLUE}â„¹ï¸ Nginx jÃ¡ configurado${NC}"
          fi
          
          echo -e "${GREEN}âœ… Deploy concluÃ­do com sucesso!${NC}"
          echo -e "${BLUE}ðŸŒ AplicaÃ§Ã£o: https://smartlead.jeansilva.dev.br${NC}"
          echo -e "${BLUE}ðŸ“š API Docs: https://smartlead.jeansilva.dev.br/api/documentation${NC}"
          
          # Verificar status dos containers
          echo -e "${YELLOW}ðŸ“Š Status dos containers:${NC}"
          docker-compose -f docker-compose.prod.yml ps || echo "Erro ao verificar containers"
          
          # Verificar se a aplicaÃ§Ã£o estÃ¡ respondendo
          echo -e "${YELLOW}ðŸ” Testando aplicaÃ§Ã£o...${NC}"
          sleep 10
          curl -f http://localhost:8080/api/health || echo "âš ï¸ AplicaÃ§Ã£o pode estar iniciando ainda"
        
    - name: ðŸ” Verify Deployment
      run: |
        echo "ðŸ” Verificando se a aplicaÃ§Ã£o estÃ¡ online..."
        sleep 30
        curl -f http://${{ secrets.SERVER_HOST }}:8080/api/health || echo "âš ï¸ AplicaÃ§Ã£o pode estar iniciando ainda..."
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "### ðŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status**: Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **URL**: https://smartlead.jeansilva.dev.br" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“š **API Docs**: https://smartlead.jeansilva.dev.br/api/documentation" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ• **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”§ **Services deployed**:" >> $GITHUB_STEP_SUMMARY
        echo "- Nginx (Proxy)" >> $GITHUB_STEP_SUMMARY
        echo "- Laravel API" >> $GITHUB_STEP_SUMMARY
        echo "- Vue.js Frontend" >> $GITHUB_STEP_SUMMARY
        echo "- MySQL Database" >> $GITHUB_STEP_SUMMARY
        echo "- Redis Cache" >> $GITHUB_STEP_SUMMARY
