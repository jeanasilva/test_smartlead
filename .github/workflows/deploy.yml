name: ðŸš€ Deploy SmartLead

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "ðŸš€ Deploy SmartLead"
          
          cd /root
          
          # Clone ou update
          if [ ! -d "smartlead" ]; then
            git clone https://github.com/jeanasilva/test_smartlead.git smartlead
          else
            cd smartlead
            git pull origin main
            cd ..
          fi
          
          cd smartlead
          
          # Criar .env simples
          cat > .env.prod << EOF
          APP_NAME="SmartLead API"
          APP_ENV=production
          APP_DEBUG=false
          APP_KEY=${{ secrets.APP_KEY }}
          APP_URL=http://${{ secrets.SERVER_HOST }}:8080
          
          DB_CONNECTION=mysql
          DB_HOST=db
          DB_PORT=3306
          DB_DATABASE=smartlead_db
          DB_USERNAME=smartlead
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          MAIL_MAILER=smtp
          MAIL_HOST=smtp.zoho.com
          MAIL_PORT=587
          MAIL_USERNAME=offboard@offboard.com.br
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=tls
          MAIL_FROM_ADDRESS=offboard@offboard.com.br
          MAIL_FROM_NAME="SmartLead"
          EOF
          
          # Parar containers antigos
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          
          # Subir containers
          docker-compose -f docker-compose.prod.yml up -d --build
          
          echo "âœ… Deploy concluÃ­do"
