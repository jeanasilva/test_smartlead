#!/bin/bash

# ================================
# GUIA DE DEPLOY - SMARTLEAD
# ================================

echo "📋 GUIA DE DEPLOY - SmartLead"
echo "================================"
echo ""

echo "1️⃣ PREPARAÇÃO DO SERVIDOR"
echo "────────────────────────────"
echo "• Ubuntu 20.04 LTS ou superior"
echo "• Docker & Docker Compose instalados"
echo "• Portas 80, 443 abertas"
echo "• Domínio smartlead.jeansilva.dev.br apontando para o servidor"
echo ""

echo "2️⃣ COMANDOS DE INSTALAÇÃO NO SERVIDOR"
echo "───────────────────────────────────────"
echo ""
echo "# Atualizar sistema"
echo "sudo apt update && sudo apt upgrade -y"
echo ""
echo "# Instalar Docker"
echo "curl -fsSL https://get.docker.com -o get-docker.sh"
echo "sudo sh get-docker.sh"
echo "sudo usermod -aG docker \$USER"
echo ""
echo "# Instalar Docker Compose"
echo "sudo curl -L \"https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose"
echo "sudo chmod +x /usr/local/bin/docker-compose"
echo ""
echo "# Instalar Make"
echo "sudo apt install make -y"
echo ""

echo "3️⃣ DEPLOY DA APLICAÇÃO"
echo "────────────────────────"
echo ""
echo "# 1. Clone o repositório"
echo "git clone <SEU_REPOSITORIO> smartlead"
echo "cd smartlead"
echo ""
echo "# 2. Configure as variáveis de produção"
echo "cp .env.prod.example .env.prod"
echo "nano .env.prod  # Configure suas senhas e chaves"
echo ""
echo "# 3. Execute o deploy"
echo "make deploy"
echo ""

echo "4️⃣ CONFIGURAÇÕES IMPORTANTES"
echo "──────────────────────────────"
echo ""
echo "📁 ARQUIVO .env.prod (Configure antes do deploy):"
echo ""
echo "DB_PASSWORD=SuaSenhaMySQLSegura123!"
echo "MYSQL_ROOT_PASSWORD=SuaSenhaRootSegura123!"
echo "APP_KEY=base64:GeradoAutomaticamente"
echo "JWT_SECRET=SuaChaveJWTSegura123"
echo "APP_URL=https://smartlead.jeansilva.dev.br"
echo "VUE_APP_API_BASE_URL=https://smartlead.jeansilva.dev.br/api"
echo ""

echo "5️⃣ COMANDOS ÚTEIS PÓS-DEPLOY"
echo "──────────────────────────────"
echo ""
echo "# Ver logs da aplicação"
echo "make logs"
echo ""
echo "# Acessar shell do backend"
echo "make shell"
echo ""
echo "# Backup do banco"
echo "docker-compose -f docker-compose.prod.yml exec db mysqldump -u root -p smartlead_db > backup_\$(date +%Y%m%d).sql"
echo ""
echo "# Atualizar aplicação"
echo "git pull origin main && make deploy"
echo ""

echo "6️⃣ URLS APÓS DEPLOY"
echo "─────────────────────"
echo ""
echo "🌐 Frontend:     https://smartlead.jeansilva.dev.br"
echo "🔗 API:          https://smartlead.jeansilva.dev.br/api"
echo "📚 Docs API:     https://smartlead.jeansilva.dev.br/api/documentation"
echo ""

echo "7️⃣ TROUBLESHOOTING"
echo "────────────────────"
echo ""
echo "❌ Se der erro de permissão:"
echo "sudo chown -R \$USER:\$USER ."
echo "sudo chmod +x deploy.sh"
echo ""
echo "❌ Se o SSL não funcionar:"
echo "Verifique se o domínio está apontando corretamente"
echo "Aguarde até 24h para propagação do DNS"
echo ""
echo "❌ Se a aplicação não subir:"
echo "docker-compose -f docker-compose.prod.yml logs -f"
echo ""

echo "✅ DEPLOY CONCLUÍDO!"
echo ""
echo "Acesse: https://smartlead.jeansilva.dev.br"
echo "Login padrão: admin@smartlead.com / password"
echo ""
echo "📞 Suporte: Verifique os logs com 'make logs'"
echo ""
echo "⚠️  IMPORTANTE - CONFIGURAÇÃO DE PORTAS"
echo "────────────────────────────────────────"
echo ""
echo "Como já existe um serviço na porta 3000, o SmartLead usará:"
echo "• Porta 8080 para HTTP"
echo "• Porta 8443 para HTTPS"
echo ""
echo "Configure seu proxy reverso principal (nginx/cloudflare) para:"
echo "• smartlead.jeansilva.dev.br -> http://localhost:8080"
echo ""
echo "Exemplo de configuração nginx do servidor:"
echo "server {"
echo "    listen 80;"
echo "    server_name smartlead.jeansilva.dev.br;"
echo "    location / {"
echo "        proxy_pass http://localhost:8080;"
echo "        proxy_set_header Host \$host;"
echo "        proxy_set_header X-Real-IP \$remote_addr;"
echo "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;"
echo "        proxy_set_header X-Forwarded-Proto \$scheme;"
echo "    }"
echo "}"
